var express = require('express');
var app = express();

app.set('port', (process.env.PORT || 5000));

var bodyParser = require("body-parser");
app.use(bodyParser.json()); //soporte para codificar json
app.use(bodyParser.urlencoded({ extended: true})); //soporte para codificar las url

var firebase = require("firebase");
firebase.initializeApp({
	serviceAccount: "PetShop-a57ee06acef4.json",
	databaseURL: "https://petshop-80e0b.firebaseio.com"
});

app.use(express.static(__dirname + '/public'));

// views is directory for all template files
app.set('views', __dirname + '/views');
app.set('view engine', 'ejs');

app.get('/android', function(request, response) {
  response.render('pages/index');
});

//POST
//https://shrouded-everglades-58752.herokuapp.com/registrar-usuario
//parametro que recive se llama id_dispositivo

app.post("/token-device", function(request, response){	
		response.send(request.body.token);
});

var id_dispositivoDeviceUri = "registrar-usuario";
app.post('/' + id_dispositivoDeviceUri, function(request, response){	
	var id_dispositivo = request.body.id_dispositivo;
	var id_usuario_instagram = request.body.id_usuario_instagram;
	
	var db = firebase.database();
	var id_dispositivoDevices = db.ref(id_dispositivoDeviceUri).push(); //define una ruta en la bd
	id_dispositivoDevices.set({		
		id_dispositivo: id_dispositivo,
		id_usuario_instagram: id_usuario_instagram		
	}); //en la ruta definida inserta el id_dispositivo recibido
		
		var respuesta = generarRespuestaAid_dispositivo(db);
		response.setHeader("Content-Type","application/json");
		
		response.send(JSON.stringify(respuesta));
});

function generarRespuestaAid_dispositivo(db){
	var respuesta = {};
	var usuario = "";
	var ref = db.ref("registrar-usuario");
	ref.on("child_added", function(snapshot, prevChildKey) {
		usuario = snapshot.val();
		respuesta = {
			id_dispositivo: usuario.id_dispositivo,
			id_usuario_instagram: usuario.id_usuario_instagram
		};		
	})
	return respuesta;	
}

app.listen(app.get('port'), function() {
  console.log('Node app is running on port', app.get('port'));
});


